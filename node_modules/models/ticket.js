var log4js = require('log4js');
var log = log4js.getLogger();
var redis = require("redis"),
    client = redis.createClient();
var HttpError = require('error').HttpError;
var User = require("models/user").User;

function ticket(req, res, next, code, amount){
	this.req = req;
	this.res = res;
	this.next = next;
	this.code = code;
	this.amount = amount;
}

ticket.prototype = {

	bill_opened: function(){
		log.info("bill_opened");
		client.set(this.code, this.amount);
	},


	bill_closed: function(){
		var next = this.next;
		var req = this.req;
		var code = this.code;
		client.get(code, function (err, amount) {
			if(err) {
				var err = new HttpError(500, "Redis connection failed");
				log.error(err);
				next(err);
			}
			User.upMoney(req.session.user._id, amount, function(err){
				if(err){
					var err = new HttpError(500, "MongoDB failed");
					log.error(err);
					next(err);
				}
			});
		});
		client.del(code);
	}

}

exports.Ticket = ticket;